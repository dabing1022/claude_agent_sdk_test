# 代码沙箱方案对比分析

本文档详细对比了将 Claude Agent SDK 工具执行放入沙箱的几种主流方案。

## 1. 方案概览

| 特性 | E2B | Daytona | Docker Sandboxes |
|------|-----|---------|------------------|
| **隔离技术** | Firecracker microVM | Docker 容器 | Docker 容器 (计划 microVM) |
| **冷启动时间** | ~150ms | ~90ms | 依赖本地 Docker |
| **最大运行时间** | 24小时 (Pro) | 无限制 | 无限制 |
| **价格** | $0.0828/小时 | $0.0828/小时 | 免费 (本地运行) |
| **SDK 支持** | Python, TypeScript | Python, TypeScript, Go | CLI 工具 |
| **开源** | 部分开源 | 是 | Docker Desktop 功能 |
| **状态** | 生产就绪 | 生产就绪 | 实验性 |

## 2. E2B (推荐)

### 优点
- **强隔离性**: 使用 Firecracker microVM，提供硬件级别隔离
- **AI 原生设计**: 专为 AI agent 代码执行设计
- **丰富的 SDK**: 提供 Python 和 TypeScript SDK，易于集成
- **模板系统**: 支持自定义环境模板，可预装依赖
- **文件持久化**: 支持文件存储和会话状态保持
- **企业级支持**: 有专业团队支持和 SLA

### 缺点
- **按使用计费**: 需要持续付费，成本随使用量增长
- **网络依赖**: 需要互联网连接到 E2B 服务
- **会话限制**: 免费版最长 1 小时，Pro 版最长 24 小时
- **并发限制**: 免费版最多 20 个并发沙箱

### 定价详情
```
Hobby (免费):
- $100 一次性积分
- 最长 1 小时会话
- 最多 20 个并发沙箱

Pro ($150/月):
- 包含 $150 使用积分
- 最长 24 小时会话
- 最多 100 个并发沙箱
- 可自定义 CPU/RAM

使用成本:
- CPU: $0.000014/vCPU/秒
- RAM: $0.0000045/GiB/秒
- 约 $0.0828/小时 (标准配置)
```

### 适用场景
- 生产环境 AI agent 部署
- 需要强隔离性的代码执行
- 多租户 SaaS 平台
- 需要可扩展性的场景

## 3. Daytona

### 优点
- **极快启动**: 90ms 沙箱创建时间
- **Agent 原生设计**: 所有操作都有 API 接口，无需人工干预
- **声明式构建**: 支持动态 Docker 镜像构建
- **MCP Server 支持**: 原生支持 MCP 协议
- **LangChain 集成**: 官方 LangChain 集成
- **Git 支持**: 内置版本控制操作

### 缺点
- **Docker 容器隔离**: 相比 microVM 隔离性较弱
- **新兴平台**: 相对较新，生态系统还在发展
- **本地运行限制**: 部分功能需要云服务

### 适用场景
- 需要快速启动的场景
- LangChain/MCP 生态系统集成
- 开发和测试环境
- 需要完整开发工具的场景

## 4. Docker Sandboxes

### 优点
- **本地运行**: 在本地 Docker Desktop 运行，无需外部服务
- **免费使用**: 无额外费用
- **路径一致性**: 沙箱内外路径保持一致
- **Git 凭证注入**: 自动处理 Git 认证
- **状态持久化**: 每个工作区一个沙箱，状态跨会话保持

### 缺点
- **实验性功能**: 目前仍在实验阶段，可能变更
- **有限支持**: 目前仅支持 Claude Code 和 Gemini CLI
- **容器级隔离**: 隔离性不如 microVM
- **本地依赖**: 需要 Docker Desktop 4.50+

### 适用场景
- 本地开发和测试
- 个人项目
- 不想依赖外部服务的场景
- Claude Code / Gemini CLI 使用

## 5. 其他方案

### Modal
- 使用 gVisor 隔离
- Python 原生设计
- 大规模自动扩展
- 价格较高 ($0.18/小时起)

### Northflank
- 生产级 microVM 隔离
- 支持自有云部署
- 无会话时间限制
- 企业级功能

## 6. 推荐方案

### 方案选择决策树

```
需要强隔离性?
├── 是 → 需要自托管?
│       ├── 是 → Northflank (自有云)
│       └── 否 → E2B (推荐)
└── 否 → 需要本地运行?
        ├── 是 → Docker Sandboxes
        └── 否 → Daytona (最快启动)
```

### 本项目推荐: E2B + 工具代理模式

**理由**:
1. **安全性**: Firecracker microVM 提供最强隔离
2. **易集成**: Python SDK 与 Claude Agent SDK 无缝配合
3. **成本可控**: 按使用计费，适合 API 服务
4. **生产就绪**: 已被 Perplexity、Hugging Face 等公司使用

## 7. 实现架构

```
┌─────────────────────────────────────────────────────────┐
│                    API 服务器                            │
│  ┌───────────────────────────────────────────────────┐  │
│  │              Claude Agent SDK                      │  │
│  │  ┌─────────────────────────────────────────────┐  │  │
│  │  │         工具代理层 (Tool Proxy)              │  │  │
│  │  │  - 权限回调拦截                              │  │  │
│  │  │  - 工具调用转发                              │  │  │
│  │  │  - 结果转换                                  │  │  │
│  │  └────────────────────┬────────────────────────┘  │  │
│  └───────────────────────┼───────────────────────────┘  │
└──────────────────────────┼──────────────────────────────┘
                           │ HTTPS API
                           ▼
┌─────────────────────────────────────────────────────────┐
│                    E2B 沙箱服务                          │
│  ┌───────────────────────────────────────────────────┐  │
│  │              Firecracker microVM                   │  │
│  │  - Bash 命令执行                                   │  │
│  │  - 文件操作 (Read/Write/Edit)                     │  │
│  │  - 目录操作 (Glob/Grep)                           │  │
│  │  - 进程管理                                        │  │
│  └───────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

## 8. 下一步

1. 安装 E2B SDK
2. 实现工具代理层
3. 创建沙箱执行服务
4. 添加安全策略
5. 性能测试和优化
